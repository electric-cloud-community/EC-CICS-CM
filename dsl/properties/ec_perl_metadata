

# Shared Metadata
# ---------------

# Hash of regular expressions defining allowed values for parameters, keyed by parameter name
my %valid;

sub isKeyValid {
    my ($key,@array) = @_;
    $_=uc for @array;
    my %keys = map { $_ => 1 } @array;
    return exists($keys{uc($key)});
}

sub contains {
    my($key, $str) = @_;
    return (index(uc($str), uc($key)) != -1);
}

sub makeAddObjectCriteria {
    my($objectCriteria, $elementWrapper, @validCriteriaKeys) = @_;

    my @criteria = grep { /\S/ } split(/\n/,$objectCriteria);
    my $numberOfCriteria = scalar(@criteria);
    my @result;

    print "elementWrapper: $elementWrapper \n";

    foreach my $crt (@criteria) {
        if($crt ne "") {

            if(contains('ObjGroup', $crt) and contains('ObjDefVer', $crt)) {
                print "ERROR: When referring to a context-based resource definition, specify either <ObjDefVer> or <ObjGroup>. Specifying <ObjDefVer> enables you to refer to a specific version of a context-based resource definition, even when the resource definition is an orphan (does not belong to any ResGroup).
                https://www.ibm.com/support/knowledgecenter/en/SS2L7A_5.3.0/com.ibm.cics.cm.doc/ccv-api-cmd-add.html";
                exit -1;
            }

            my @listElement;
            foreach my $elem (split ' ', $crt) {
                my @keyValue = split '=', $elem;
                my $key = @keyValue[0];
                my $value = @keyValue[1];

                if(!isKeyValid($key, @validCriteriaKeys)) {
                    print "ERROR: unknown key '$key'. Allowed keys are: [" . join(", ", @validCriteriaKeys) . "]";
                    exit -1;
                }

                if($value eq "") {
                    print "ERROR: value for $key should not be empty";
                    exit -1;
                }

                if(contains('TContainer', $crt) and uc($key) eq 'COMMAND' and uc($value) ne 'ADD') {
                    print "ERROR: 'TContainer' ('target container') is relevant only when packaging an Add command. It identifies the ResGroup to which you want the resource definitions added.";
                    exit -1;
                }

                push (@listElement, SOAP::Data->name($key => $value));
            }
            if($numberOfCriteria > 1) {
                push (@result,
                    SOAP::Data->name('ListElement' => \SOAP::Data->value(
                            SOAP::Data->name("$elementWrapper" => \SOAP::Data->value(
                                    @listElement
                                ))
                        )));
            }
            else {
                push (@result, SOAP::Data->name("$elementWrapper" => \SOAP::Data->value(@listElement)));

            }

        }
    }
    if($numberOfCriteria > 1) {
        unshift (@result, SOAP::Data->name('ListCount' => $numberOfCriteria));
    }
    return @result;

}

sub makeRestrictionCriteria {
    my($rCriteria) = @_;

    my @RestrictionCriteria;

    if (length($rCriteria) > 0) {

        # First go through and collect all the counts
        my $restrictionCount = 0;
        my %listCount;
        my @lines = split(/$/, $rCriteria); # Split into lines
        foreach my $line (@lines) {
            $listCount{$line} = 0;
            my @parts = split(/\s+/, $line); # Split on whitespace
            foreach my $part (@parts) {
                my @pieces = split(/\./, $part, 3); # Split at first two .'s into field, operator, and value
                if (@pieces == 3) {
                    $listCount{$line}++;
                }
            else
            {
                print "ERROR: Unable to parse Restriction Criteria near '$part'!";
                exit -1;
            }
            }
            if ($listCount{$line} > 0) {
                $restrictionCount++;
            }
        }

        if ($restrictionCount > 0) {

            # Now we have counts, go through again and build the actual output
            push(@RestrictionCriteria, SOAP::Data->name('RestrictionCount' => $restrictionCount));
            foreach my $line (@lines) {
                if ($listCount{$line} > 0) {
                    my @RestrictionElement;
                    push(@RestrictionElement, SOAP::Data->name('ListCount' => $listCount{$line}));
                    my @parts = split(/\s+/, $line); # Split on whitespace
                    foreach my $part (@parts) {
                        my @pieces = split(/\./, $part, 3); # Split at first two .'s into field, operator, and value
                        if (@pieces == 3) {
                            push(@RestrictionElement, SOAP::Data->name('ListElement' => \SOAP::Data->value(
                                SOAP::Data->name('RestrictionField' => $pieces[0]),
                                SOAP::Data->name('RestrictionOperator' => $pieces[1]),
                                SOAP::Data->name('RestrictionValue' => $pieces[2])
                            )));
                        }
                    }
                    push(@RestrictionCriteria, SOAP::Data->name('RestrictionElement' => \SOAP::Data->value(@RestrictionElement)));
                }
            }
        }
    }
    my @result;
    push(@result, SOAP::Data->name('RestrictionCriteria' => \SOAP::Data->value(@RestrictionCriteria)));
    return @result;
}

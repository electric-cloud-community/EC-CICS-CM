

# Shared Metadata
# ---------------

# Hash of regular expressions defining allowed values for parameters, keyed by parameter name
my %valid;

sub isKeyValid {
    my ($key,@array) = @_;
    $_=uc for @array;
    my %keys = map { $_ => 1 } @array;
    return exists($keys{uc($key)});
}

sub contains {
    my($key, $str) = @_;
    return (index(uc($str), uc($key)) != -1);
}

sub makeAddObjectCriteria {
    my($objectCriteria, $elementWrapper, @validCriteriaKeys) = @_;

    # TODO implement next case: Specify <ListCount> followed by one or more <ListElement>. Each <ListElement> must identify a single object, with no masking
    # TODO implement next case: <TContainer> ("target container") is relevant only when packaging an Add command. It identifies the ResGroup to which you want the resource definitions added.
    my @criteria = split '\n', $objectCriteria;
    my @result;
    my $listCount = 0;

    print "elementWrapper: $elementWrapper \n";

    foreach my $crt (@criteria) {
        if($crt ne "") {

            if(contains('ObjGroup', $crt) and contains('ObjDefVer', $crt)) {
                print "ERROR: When referring to a context-based resource definition, specify either <ObjDefVer> or <ObjGroup>.
                Specifying <ObjDefVer> enables you to refer to a specific version of a context-based resource definition, even
                when the resource definition is an orphan (does not belong to any ResGroup).
                https://www.ibm.com/support/knowledgecenter/en/SS2L7A_5.3.0/com.ibm.cics.cm.doc/ccv-api-cmd-add.html";
                exit -1;
            }

            $listCount++;
            my @listElement;
            foreach my $elem (split ' ', $crt) {
                my @keyValue = split '=', $elem;
                my $key = @keyValue[0];
                my $value = @keyValue[1];

                if(!isKeyValid($key, @validCriteriaKeys)) {
                    print "ERROR: unknown key '$key'. Allowed keys are: [" . join(", ", @validCriteriaKeys) . "]";
                    exit -1;
                }

                if($value eq "") {
                    print "ERROR: value for $key should not be empty";
                    exit -1;
                }
                push (@listElement, SOAP::Data->name($key => $value));
            }
            push (@result,
                SOAP::Data->name('ListElement' => \SOAP::Data->value(
                        SOAP::Data->name("$elementWrapper" => \SOAP::Data->value(
                                @listElement
                            ))
                    )));

        }
    }
    unshift (@result, SOAP::Data->name('ListCount' => $listCount));
    return @result;

}
